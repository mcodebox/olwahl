/*
 map-base 2017-06-13 
*/

var map=new ol.Map({view:new ol.View({center:[1163030.7515295409,6650243.907942198],zoom:6}),layers:[new ol.layer.Tile({source:new ol.source.OSM({})})],controls:[]});map.setTarget("js-map");var zoomButtons=new ol.control.Zoom;map.addControl(zoomButtons),map.addControl(new ol.control.Attribution({collapsible:!0}));var scaleBar=new ol.control.ScaleLine({units:"metric"});map.addControl(scaleBar);var b_laender=new ol.layer.Vector({source:new ol.source.Vector({url:"data/b_laender.geojson",format:new ol.format.GeoJSON})});map.addLayer(b_laender);var container=document.getElementById("popup"),content=document.getElementById("popup-content"),closer=document.getElementById("popup-closer"),popupOverlay=new ol.Overlay({element:container,autoPan:!0,autoPanAnimation:{duration:1e3}});closer.onclick=function(){return popupOverlay.setPosition(void 0),closer.blur(),!1};var selectClick=new ol.interaction.Select({condition:ol.events.condition.click});map.addInteraction(selectClick);var chartCreated="no",featureAvailable="no",displayFeatureInfo=function(pixel){function arcTween(a){var i=d3.interpolate(this._current,a);return this._current=i(0),function(t){return arc(i(t))}}function labelarcTween(a){var i=d3.interpolate(this._current,a);return this._current=i(0),function(t){return"translate("+labelArc.centroid(i(t))+")"}}var feature=map.forEachFeatureAtPixel(pixel,function(feature){return feature});featureAvailable=feature?"yes":"no";var dataset,ergCDU,ergSPD,ergGRN,ergLNK,ergSNS;feature&&(ergCDU=ergebnisse[feature.getId()]["CDU/CSU"],ergSPD=ergebnisse[feature.getId()].SPD,ergGRN=ergebnisse[feature.getId()].GRUENE,ergLNK=ergebnisse[feature.getId()].LINKE,ergSNS=ergebnisse[feature.getId()].Sonstige,dataset=[{label:"CDU/CSU",count:ergCDU},{label:"SPD",count:ergSPD},{label:"B90/DIE GRÜNEN",count:ergGRN},{label:"DIE LINKE",count:ergLNK},{label:"Sonstige",count:ergSNS}]);var info=document.getElementById("infoboxdiv");info.innerHTML=feature?"(ID: "+feature.getId()+") "+feature.get("NAME_1"):"",ergebnissediv.innerHTML=feature?"CDU/CSU: "+ergCDU+"%, SPD: "+ergSPD+"%, B90/DIE GRÜNEN: "+ergGRN+"%, DIE LINKE: "+ergLNK+"%, Sonstige: "+ergSNS+"%":"";var pieRadius=Math.min(260,260)/2,pieColor=d3.scaleOrdinal().range(["#191919","#CC0001","#80B11A","#C4598B","#B2B2B2"]),arc=d3.arc().innerRadius(0).outerRadius(pieRadius),labelArc=d3.arc().outerRadius(pieRadius-60).innerRadius(pieRadius-60);feature&&"no"==chartCreated?(!function(){d3.select("svg").remove();var svg=d3.select("#piechartdiv").append("svg").attr("width",260).attr("height",260).append("g").attr("transform","translate(130,130)"),pie=d3.pie().value(function(d){return d.count}).sort(null);svg.selectAll("path").data(pie(dataset)).enter().append("path").attr("d",arc).attr("fill",function(d,i){return pieColor(d.data.label)}).each(function(d){this._current=d});svg.selectAll("arc").data(pie(dataset)).enter().append("text").attr("transform",function(d){return"translate("+labelArc.centroid(d)+")"}).text(function(d){return"• "+d.data.label}).style("fill","#fff").style("font-family","Verdana").style("font-size","10px").each(function(d){this._current=d})}(),chartCreated="yes",console.log("Chart created.")):feature&&"yes"==chartCreated?(!function(){var pie=d3.pie().value(function(d){return d.count})(dataset);path=d3.select("#piechartdiv").selectAll("path").data(pie),path.transition().duration(500).attrTween("d",arcTween),d3.selectAll("text").data(pie).transition().duration(500).attrTween("transform",labelarcTween)}(),console.log("Chart updated.")):(piechartdiv.innerHTML="",chartCreated="no",console.log("Chart removed."))},testVar=document.getElementById("infoboxdiv");map.on("click",function(evt){if(displayFeatureInfo(evt.pixel),"yes"==featureAvailable){map.addOverlay(popupOverlay);var coordinate=evt.coordinate,theInfo=document.getElementById("infoboxdiv"),thePie=document.getElementById("piechartdiv");document.getElementById("infoboxdiv").align="center",document.getElementById("ergebnissediv").align="center",content.appendChild(theInfo),content.appendChild(thePie),popupOverlay.setPosition(coordinate)}else closer.onclick()});